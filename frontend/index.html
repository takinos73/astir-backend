<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASTIR CMMS - Tasks</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      justify-content: center;
      align-items: center;
    }

    select {
      padding: 8px;
      font-size: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #222;
      color: white;
    }

    button {
      padding: 6px 10px;
      background: #007b00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #009b00;
    }

    .status-ok { background: #b9ffb9; }
    .status-warn { background: #fff6a5; }
    .status-bad { background: #ffbaba; }
  </style>
</head>
<body>
  <h1>Maintenance Tasks</h1>

  <div class="filters">
    <select id="machineFilter">
      <option value="all">All Machines</option>
      <input type="file" id="excelFile" accept=".xlsx">
      <button id="importExcelBtn">ðŸ“¥ Import Excel</button>
    </select>
    
    <select id="statusFilter">
      <option value="all">All Status</option>
      <option value="Planned">Planned</option>
      <option value="Done">Done</option>
    </select>

    <button id="exportSnapshot">ðŸ“¦ Export Snapshot</button>
    <input type="file" id="snapshotFile" accept="application/json">
    <button id="restoreSnapshot">â™» Restore Snapshot</button>
  </div>

  <table id="tasksTable">
    <thead>
      <tr>
        <th>Machine</th>
        <th>Section</th>
        <th>Unit</th>
        <th>Task</th>
        <th>Type</th>
        <th>Due Date</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const API = "https://astir-backend.onrender.com";
let tasksData = [];

// ðŸ—“ Format date
function formatDate(dateStr) {
  if (!dateStr) return "-";
  return new Date(dateStr).toLocaleDateString("el-GR");
}

// ðŸŽ¨ Status colors
function getStatusClass(dueDate, status) {
  if (status === "Done") return "status-ok";
  if (!dueDate) return "";
  const today = new Date();
  const date = new Date(dueDate);
  const diff = Math.ceil((date - today) / (1000*60*60*24));
  if (diff < 0) return "status-bad";
  if (diff <= 7) return "status-warn";
  return "status-ok";
}

// âœ” Mark as Done
async function markDone(id) {
  const res = await fetch(`${API}/tasks/${id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status: "Done" }),
  });

  if (res.ok) {
    const t = tasksData.find(x => x.id === id);
    t.status = "Done";
    renderTable();
  }
}

// ðŸ“‹ Render Data
function renderTable() {
  const machineFilter = document.getElementById("machineFilter").value;
  const statusFilter = document.getElementById("statusFilter").value;
  const tableBody = document.querySelector("#tasksTable tbody");
  tableBody.innerHTML = "";

  tasksData
    .filter(t =>
      (machineFilter === "all" || t.machine_name === machineFilter) &&
      (statusFilter === "all" || t.status === statusFilter)
    )
    .forEach(t => {
      const row = document.createElement("tr");
      row.className = getStatusClass(t.due_date, t.status);
      row.innerHTML = `
        <td>${t.machine_name}</td>
        <td>${t.section || "-"}</td>
        <td>${t.unit || "-"}</td>
        <td>${t.task}</td>
        <td>${t.type || "-"}</td>
        <td>${formatDate(t.due_date)}</td>
        <td>${t.status}</td>
        <td>${t.status !== "Done"
          ? `<button onclick="markDone(${t.id})">âœ” Done</button>`
          : "âœ“"}</td>
      `;
      tableBody.appendChild(row);
    });
}

// ðŸ”½ Filters Load
  async function loadFilters() {
  const res = await fetch(`${API}/machines`);
  const machines = await res.json();
  const select = document.getElementById("machineFilter");
  machines.forEach(m => {
  const opt = document.createElement("option");
  opt.value = m.name;
  opt.textContent = m.name;
  select.appendChild(opt);
  });
}

// ðŸ”½ Tasks Load
async function loadTasks() {
  const res = await fetch(`${API}/tasks`);
  tasksData = await res.json();
  renderTable();
}

// ðŸ“¦ Export Snapshot â€” USER NAMED FILE
async function exportSnapshot() {
  const nameInput = prompt("Enter snapshot name:", "Backup");
  if (!nameInput || !nameInput.trim()) return;

  const res = await fetch(`${API}/snapshot/export`);
  const data = await res.json();

  const clean = nameInput.trim().replace(/[^a-zA-Z0-9_-]/g, "_");
  const time = new Date().toISOString().replace(/[:.]/g, "-");
  const filename = `snapshot_${clean}_${time}.json`;

  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: "application/json"
  });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

// â™» Restore Snapshot from file
document.getElementById("snapshotFile").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const text = await file.text();
  let json;
  try { json = JSON.parse(text); }
  catch { return alert("Invalid snapshot file!"); }

  const res = await fetch(`${API}/snapshot/restore`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(json)
  });

  if (!res.ok) return alert("Restore failed!");
  
  alert("Snapshot restored!");
  loadTasks();
});

// ðŸ“Œ Event Listeners
document.getElementById("exportSnapshot").addEventListener("click", exportSnapshot);
document.getElementById("machineFilter").addEventListener("change", renderTable);
document.getElementById("statusFilter").addEventListener("change", renderTable);

// ðŸš€ Init
loadFilters();
loadTasks();
</script>

</body>
</html>

