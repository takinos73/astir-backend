<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ASTIR CMMS - Tasks</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      justify-content: center;
      align-items: center;
    }

    select {
      padding: 8px;
      font-size: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #222;
      color: white;
    }

    button {
      padding: 6px 10px;
      background: #007b00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background: #009b00;
    }

    .status-ok { background: #b9ffb9; }
    .status-warn { background: #fff6a5; }
    .status-bad { background: #ffbaba; }
  </style>
</head>
<body>
  <h1>Maintenance Tasks</h1>

  <div class="filters">
    <select id="machineFilter">
      <option value="all">All Machines</option>
    </select>

    <select id="statusFilter">
      <option value="all">All Status</option>
      <option value="Planned">Planned</option>
      <option value="Done">Done</option>
    </select>

    <button id="exportSnapshot">ðŸ“¦ Export Snapshot</button>
    <input type="file" id="snapshotFile" accept="application/json">
    <button id="restoreSnapshot">â™» Restore Snapshot</button>
  </div>

  <table id="tasksTable">
    <thead>
      <tr>
        <th>Machine</th>
        <th>Section</th>
        <th>Unit</th>
        <th>Task</th>
        <th>Type</th>
        <th>Due Date</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const API = "https://astir-backend.onrender.com";
  let tasksData = [];

  function formatDate(dateStr) {
    if (!dateStr) return "-";
    const d = new Date(dateStr);
    return d.toLocaleDateString("el-GR");
  }

  function getStatusClass(dueDate, status) {
    if (status === "Done") return "status-ok";
    if (!dueDate) return "";
    const today = new Date();
    const date = new Date(dueDate);
    const diffDays = Math.ceil((date - today) / (1000*60*60*24));
    if (diffDays < 0) return "status-bad";
    if (diffDays <= 7) return "status-warn";
    return "status-ok";
  }

  async function markDone(id) {
    const res = await fetch(`${API}/tasks/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: "Done" }),
    });

    if (res.ok) {
      const task = tasksData.find(t => t.id === id);
      task.status = "Done";
      renderTable();
    } else {
      alert("Failed to update task!");
    }
  }
  function renderTable() {
    const machineFilter = document.getElementById("machineFilter").value;
    const statusFilter = document.getElementById("statusFilter").value;

    const tableBody = document.querySelector("#tasksTable tbody");
    tableBody.innerHTML = "";

    tasksData
      .filter(t =>
        (machineFilter === "all" || t.machine_name === machineFilter) &&
        (statusFilter === "all" || t.status === statusFilter)
      )
      .forEach(t => {
        const row = document.createElement("tr");
        row.className = getStatusClass(t.due_date, t.status);

        row.innerHTML = `
          <td>${t.machine_name}</td>
          <td>${t.section || "-"}</td>
          <td>${t.unit || "-"}</td>
          <td>${t.task}</td>
          <td>${t.type || "-"}</td>
          <td>${formatDate(t.due_date)}</td>
          <td>${t.status}</td>
          <td>
            ${t.status !== "Done"
              ? `<button onclick="markDone(${t.id})">âœ” Done</button>`
              : "âœ“"}
          </td>
        `;
        tableBody.appendChild(row);
      });
  }
  async function loadFilters() {
    const res = await fetch(`${API}/machines`);
    const machines = await res.json();
    const select = document.getElementById("machineFilter");

    machines.forEach(m => {
      const option = document.createElement("option");
      option.value = m.name;
      option.textContent = m.name;
      select.appendChild(option);
    });
  }

  async function loadTasks() {
    const res = await fetch(`${API}/tasks`);
    tasksData = await res.json();
    renderTable();
  }

  document.getElementById("machineFilter").addEventListener("change", renderTable);
  document.getElementById("statusFilter").addEventListener("change", renderTable);

  // ðŸ’¾ EXPORT Snapshotasync 
async function exportSnapshot() {
  const nameInput = prompt("Enter snapshot name:", "Backup");
  if (!nameInput || !nameInput.trim()) {
    alert("Snapshot name is required!");
    return;
  }

  const res = await fetch(`${API}/snapshot/export`);

  if (!res.ok) {
    alert("Export failed!");
    return;
  }

  const data = await res.json();

  const cleanName = nameInput.trim().replace(/[^a-zA-Z0-9_-]/g, "_");
  const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
  const filename = `snapshot_${cleanName}_${timestamp}.json`;

  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: "application/json"
  });

  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();

  URL.revokeObjectURL(link.href);
}
  document.getElementById("exportSnapshot").addEventListener("click", () => {
  window.location.href = `${API}/snapshot/export`;
  });

  // ðŸ”„ RESTORE Snapshot from File
 

  loadFilters();
  loadTasks();
</script>

</body>
</html>

